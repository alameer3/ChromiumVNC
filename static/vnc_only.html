<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VNC Remote Desktop</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #1a1a1a;
            color: #ffffff;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        .vnc-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }
        
        #vncCanvas {
            max-width: 100%;
            max-height: 100%;
            border: 1px solid #333;
            background: #222;
        }
        
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            margin-right: 20px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .status-connected .status-dot {
            background: #00ff00;
            animation: pulse 2s infinite;
        }
        
        .status-disconnected .status-dot {
            background: #ff0000;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 2000;
        }
        
        .loading-spinner {
            font-size: 48px;
            margin-bottom: 20px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            color: #ccc;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-indicator" id="connectionStatus">
            <span>غير متصل</span>
            <div class="status-dot"></div>
        </div>
        <div class="status-indicator">
            <span>الدقة: <span id="resolution">1280x720</span></span>
        </div>
    </div>
    
    <!-- VNC Display -->
    <div class="vnc-container">
        <canvas id="vncCanvas" width="1280" height="720"></canvas>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">⟲</div>
        <div class="loading-text">جاري الاتصال بسطح المكتب البعيد...</div>
    </div>

    <script>
        class SimpleVNCClient {
            constructor() {
                this.canvas = document.getElementById('vncCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.websocket = null;
                this.connected = false;
                
                this.statusElement = document.getElementById('connectionStatus');
                this.loadingOverlay = document.getElementById('loadingOverlay');
                
                this.setupEventListeners();
                this.connect();
            }
            
            connect() {
                const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
                const wsUrl = `${protocol}//${window.location.hostname}:8000`;
                
                console.log('جاري الاتصال بـ:', wsUrl);
                
                this.websocket = new WebSocket(wsUrl);
                
                this.websocket.onopen = () => {
                    console.log('تم الاتصال بنجاح');
                    this.connected = true;
                    this.updateStatus(true);
                    this.hideLoading();
                    this.startScreenshotUpdates();
                };
                
                this.websocket.onmessage = (event) => {
                    this.handleMessage(event.data);
                };
                
                this.websocket.onclose = () => {
                    console.log('انقطع الاتصال');
                    this.connected = false;
                    this.updateStatus(false);
                    this.showLoading();
                    
                    // إعادة المحاولة بعد 3 ثوان
                    setTimeout(() => this.connect(), 3000);
                };
                
                this.websocket.onerror = (error) => {
                    console.error('خطأ في الاتصال:', error);
                    this.updateStatus(false);
                };
            }
            
            handleMessage(data) {
                try {
                    const message = JSON.parse(data);
                    
                    if (message.type === 'vnc_data') {
                        this.displayScreenshot(message.data);
                    }
                } catch (error) {
                    console.error('خطأ في معالجة الرسالة:', error);
                }
            }
            
            displayScreenshot(base64Data) {
                const img = new Image();
                img.onload = () => {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.ctx.drawImage(img, 0, 0, this.canvas.width, this.canvas.height);
                };
                img.src = 'data:image/png;base64,' + base64Data;
            }
            
            startScreenshotUpdates() {
                // طلب لقطات الشاشة كل ثانية
                setInterval(() => {
                    if (this.connected && this.websocket.readyState === WebSocket.OPEN) {
                        this.websocket.send(JSON.stringify({
                            type: 'request_screenshot'
                        }));
                    }
                }, 1000);
            }
            
            setupEventListeners() {
                // أحداث الماوس
                this.canvas.addEventListener('mousedown', (e) => this.handleMouseEvent(e, 'down'));
                this.canvas.addEventListener('mouseup', (e) => this.handleMouseEvent(e, 'up'));
                this.canvas.addEventListener('mousemove', (e) => this.handleMouseEvent(e, 'move'));
                
                // أحداث لوحة المفاتيح
                document.addEventListener('keydown', (e) => this.handleKeyEvent(e, true));
                document.addEventListener('keyup', (e) => this.handleKeyEvent(e, false));
                
                // منع القائمة السياقية
                this.canvas.addEventListener('contextmenu', (e) => e.preventDefault());
            }
            
            handleMouseEvent(event, action) {
                if (!this.connected) return;
                
                const rect = this.canvas.getBoundingClientRect();
                const x = Math.floor((event.clientX - rect.left) * (this.canvas.width / rect.width));
                const y = Math.floor((event.clientY - rect.top) * (this.canvas.height / rect.height));
                
                let buttons = 0;
                if (event.buttons & 1) buttons |= 1; // Left button
                if (event.buttons & 2) buttons |= 4; // Right button
                if (event.buttons & 4) buttons |= 2; // Middle button
                
                this.websocket.send(JSON.stringify({
                    type: 'mouse_event',
                    x: x,
                    y: y,
                    buttons: buttons,
                    action: action
                }));
            }
            
            handleKeyEvent(event, pressed) {
                if (!this.connected) return;
                
                this.websocket.send(JSON.stringify({
                    type: 'key_event',
                    key: event.key,
                    code: event.code,
                    pressed: pressed
                }));
                
                // منع السلوك الافتراضي لبعض المفاتيح
                if (['F5', 'F11', 'F12'].includes(event.key) || 
                    (event.ctrlKey && ['r', 'R', 'w', 'W'].includes(event.key))) {
                    event.preventDefault();
                }
            }
            
            updateStatus(connected) {
                if (connected) {
                    this.statusElement.innerHTML = '<span>متصل</span><div class="status-dot"></div>';
                    this.statusElement.className = 'status-indicator status-connected';
                } else {
                    this.statusElement.innerHTML = '<span>غير متصل</span><div class="status-dot"></div>';
                    this.statusElement.className = 'status-indicator status-disconnected';
                }
            }
            
            showLoading() {
                this.loadingOverlay.classList.remove('hidden');
            }
            
            hideLoading() {
                this.loadingOverlay.classList.add('hidden');
            }
        }
        
        // بدء التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            window.vncClient = new SimpleVNCClient();
        });
    </script>
</body>
</html>